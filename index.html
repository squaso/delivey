<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover" name="viewport"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kome Driver">
    <title>Kome â€” Repartidor</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@10..48,600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>

    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDUNTpFKdTVDC2N-G1tqP377kWr2iddpA4&libraries=places&loading=async" async defer></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#06300A",
                        "accent": "#007AFF",
                        "dark-bg": "#1C1C1E",
                        "surface": "#1a1a1a",
                        "light-bg": "#E5E5EA",
                    },
                    fontFamily: {
                        "display": ["Bricolage Grotesque", "sans-serif"],
                        "body": ["Plus Jakarta Sans", "sans-serif"]
                    }
                }
            }
        }

        // Tema segÃºn sistema
        ;(function() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark') document.documentElement.classList.add('dark');
            else if (saved === 'light') document.documentElement.classList.remove('dark');
            else if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
        })();
    </script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .font-display { font-family: 'Bricolage Grotesque', sans-serif; }
        .pulse-ring { animation: pulseRing 2s infinite; }
        @keyframes pulseRing {
            0% { box-shadow: 0 0 0 0 rgba(6, 48, 10, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(6, 48, 10, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 48, 10, 0); }
        }
    </style>
</head>

<body class="bg-light-bg text-gray-900 dark:bg-dark-bg dark:text-white min-h-[100dvh]">

    <!-- LOGIN / REGISTRO DEL REPARTIDOR -->
    <div id="driver-login" class="min-h-[100dvh] flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <div class="text-center mb-10">
                <div class="size-16 bg-primary rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-primary/20">
                    <span class="material-symbols-rounded text-white text-3xl">delivery_dining</span>
                </div>
                <h1 class="text-2xl font-display font-bold mb-1">Kome Driver</h1>
                <p class="text-gray-500 dark:text-white/50 text-sm">Panel de Repartidores</p>
            </div>

            <!-- Toggle Login / Registro -->
            <div class="bg-gray-100 dark:bg-white/5 p-1.5 rounded-2xl flex mb-6">
                <button id="tab-driver-login" onclick="driverApp.setMode('login')"
                    class="flex-1 py-3 rounded-xl text-sm font-bold transition-all shadow-sm bg-white dark:bg-surface text-gray-900 dark:text-white">
                    Iniciar SesiÃ³n
                </button>
                <button id="tab-driver-signup" onclick="driverApp.setMode('signup')"
                    class="flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 dark:text-white/40 transition-all">
                    Registrarse
                </button>
            </div>

            <div class="space-y-4">
                <!-- Campos solo para registro -->
                <div id="signup-fields" class="hidden space-y-4">
                    <input id="driver-name-input" type="text" placeholder="Nombre completo"
                        class="w-full bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-2xl py-4 px-5 text-sm font-medium focus:ring-0 focus:border-primary outline-none">
                    <input id="driver-phone-input" type="tel" placeholder="TelÃ©fono (ej: 809 555 1234)"
                        class="w-full bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-2xl py-4 px-5 text-sm font-medium focus:ring-0 focus:border-primary outline-none">
                    
                    <!-- Selector de VehÃ­culo -->
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1">VehÃ­culo</p>
                        <div class="grid grid-cols-4 gap-2" id="vehicle-selector">
                            <button type="button" onclick="driverApp.selectVehicle('moto')" data-vehicle="moto"
                                class="vehicle-btn flex flex-col items-center gap-1 py-3 rounded-xl border-2 border-primary bg-primary/5 transition-all active:scale-95">
                                <span class="text-xl">ðŸ›µ</span>
                                <span class="text-[9px] font-bold text-gray-600 dark:text-white/60">Moto</span>
                            </button>
                            <button type="button" onclick="driverApp.selectVehicle('bicicleta')" data-vehicle="bicicleta"
                                class="vehicle-btn flex flex-col items-center gap-1 py-3 rounded-xl border border-gray-200 dark:border-white/10 transition-all active:scale-95">
                                <span class="text-xl">ðŸš²</span>
                                <span class="text-[9px] font-bold text-gray-600 dark:text-white/60">Bici</span>
                            </button>
                            <button type="button" onclick="driverApp.selectVehicle('auto')" data-vehicle="auto"
                                class="vehicle-btn flex flex-col items-center gap-1 py-3 rounded-xl border border-gray-200 dark:border-white/10 transition-all active:scale-95">
                                <span class="text-xl">ðŸš—</span>
                                <span class="text-[9px] font-bold text-gray-600 dark:text-white/60">Auto</span>
                            </button>
                            <button type="button" onclick="driverApp.selectVehicle('pie')" data-vehicle="pie"
                                class="vehicle-btn flex flex-col items-center gap-1 py-3 rounded-xl border border-gray-200 dark:border-white/10 transition-all active:scale-95">
                                <span class="text-xl">ðŸš¶</span>
                                <span class="text-[9px] font-bold text-gray-600 dark:text-white/60">A pie</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Campos comunes -->
                <input id="driver-email" type="email" placeholder="Correo electrÃ³nico"
                    class="w-full bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-2xl py-4 px-5 text-sm font-medium focus:ring-0 focus:border-primary outline-none">
                <input id="driver-password" type="password" placeholder="ContraseÃ±a"
                    class="w-full bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-2xl py-4 px-5 text-sm font-medium focus:ring-0 focus:border-primary outline-none">
                
                <button onclick="driverApp.submitAuth()" id="driver-login-btn"
                    class="w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg shadow-primary/20 active:scale-95 transition-all text-sm">
                    Iniciar SesiÃ³n
                </button>
            </div>
            <p id="driver-login-error" class="text-red-500 text-xs font-bold text-center mt-4 hidden"></p>
        </div>
    </div>

    <!-- DASHBOARD DEL REPARTIDOR -->
    <div id="driver-dashboard" class="hidden min-h-[100dvh] flex flex-col">

        <!-- Header -->
        <header class="sticky top-0 z-40 bg-white/90 dark:bg-dark-bg/90 backdrop-blur-xl border-b border-gray-100 dark:border-white/5">
            <div class="max-w-lg mx-auto px-5 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-xl bg-primary flex items-center justify-center text-white shadow-md">
                        <span class="material-symbols-rounded text-xl">delivery_dining</span>
                    </div>
                    <div>
                        <h2 id="driver-name" class="text-sm font-bold">Repartidor</h2>
                        <p id="driver-status-label" class="text-[10px] font-bold text-green-500 uppercase tracking-widest">Disponible</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="driverApp.toggleAvailability()" id="btn-toggle-available"
                        class="size-10 rounded-xl bg-green-50 dark:bg-green-500/10 text-green-500 flex items-center justify-center active:scale-90 transition-transform">
                        <span id="icon-available" class="material-symbols-rounded">toggle_on</span>
                    </button>
                    <button onclick="driverApp.logout()"
                        class="size-10 rounded-xl bg-red-50 dark:bg-red-500/10 text-red-500 flex items-center justify-center active:scale-90 transition-transform">
                        <span class="material-symbols-rounded">logout</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Contenido Principal -->
        <main class="flex-1 max-w-lg mx-auto w-full px-5 py-6 space-y-6">

            <!-- Estado de Tracking -->
            <div id="tracking-control" class="hidden">
                <div class="bg-white dark:bg-surface border border-gray-100 dark:border-white/5 rounded-3xl p-6 shadow-xl relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 size-32 bg-primary/10 rounded-full blur-2xl"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Pedido Activo</p>
                                <h3 id="active-order-id" class="text-lg font-display font-bold">â€”</h3>
                            </div>
                            <div id="tracking-indicator" class="size-14 rounded-2xl bg-gray-100 dark:bg-white/5 flex items-center justify-center">
                                <span class="material-symbols-rounded text-gray-400 text-2xl">location_off</span>
                            </div>
                        </div>

                        <div id="active-order-address" class="flex items-start gap-2 mb-5 bg-gray-50 dark:bg-black/20 p-3 rounded-xl">
                            <span class="material-symbols-rounded text-primary text-lg mt-0.5">location_on</span>
                            <p class="text-xs text-gray-600 dark:text-white/60 font-medium leading-relaxed">Sin pedido asignado</p>
                        </div>

                        <!-- BotÃ³n de Tracking ON/OFF -->
                        <button onclick="driverApp.toggleTracking()" id="btn-toggle-tracking"
                            class="w-full py-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-all active:scale-95
                            bg-primary text-white shadow-lg shadow-primary/20">
                            <span class="material-symbols-rounded">play_arrow</span>
                            <span id="btn-tracking-text">Iniciar Ruta</span>
                        </button>

                        <!-- BotÃ³n Marcar como Entregado -->
                        <button onclick="driverApp.markDelivered()" id="btn-mark-delivered"
                            class="hidden w-full py-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-all active:scale-95 mt-3
                            bg-green-600 text-white shadow-lg shadow-green-500/20">
                            <span class="material-symbols-rounded">check_circle</span>
                            Marcar como Entregado
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de Pedidos Pendientes -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-display font-bold">Pedidos Disponibles</h3>
                    <button onclick="driverApp.loadPendingOrders()" class="size-9 rounded-xl bg-gray-100 dark:bg-white/5 flex items-center justify-center active:scale-90 transition-transform">
                        <span class="material-symbols-rounded text-gray-400">refresh</span>
                    </button>
                </div>
                <div id="pending-orders-list" class="space-y-4">
                    <div class="text-center py-10 opacity-40">
                        <span class="material-symbols-rounded text-4xl">inbox</span>
                        <p class="text-sm font-bold mt-2">Sin pedidos pendientes</p>
                    </div>
                </div>
            </section>

            <!-- Historial -->
            <section>
                <h3 class="text-lg font-display font-bold mb-4">Entregas de Hoy</h3>
                <div id="completed-orders-list" class="space-y-3">
                    <p class="text-center text-gray-400 text-xs py-4">Sin entregas hoy</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="driver-toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-50 bg-white dark:bg-surface shadow-2xl rounded-2xl px-5 py-4 flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-8 pointer-events-none max-w-sm w-full border border-gray-100 dark:border-white/5">
        <span id="toast-icon" class="material-symbols-rounded text-primary text-xl">check_circle</span>
        <p id="toast-text" class="text-sm font-bold flex-1">Mensaje</p>
    </div>

    <script>
    const SUPABASE_URL = 'https://zoitswrhrrvfggwkocvz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvaXRzd3JocnJ2Zmdnd2tvY3Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMTM5NzksImV4cCI6MjA4MjY4OTk3OX0.RL4FgGc4c0_RH_lleQSZNmEeIgG4kM6Qh6U0eBh1jVc';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const driverApp = {
        profile: null,          // Perfil del repartidor
        activeOrder: null,      // Pedido activo actual
        isTracking: false,      // Si estÃ¡ enviando ubicaciÃ³n
        watchId: null,          // ID del watchPosition de GPS
        sendInterval: null,     // Intervalo de envÃ­o de ubicaciÃ³n
        lastPosition: null,     // Ãšltima posiciÃ³n GPS
        isAvailable: true,
        isLoginMode: true,      // Toggle login/registro
        selectedVehicle: 'moto', // VehÃ­culo seleccionado

        // ============ MODO LOGIN / REGISTRO ============

        setMode(mode) {
            this.isLoginMode = (mode === 'login');
            const tabLogin = document.getElementById('tab-driver-login');
            const tabSignup = document.getElementById('tab-driver-signup');
            const signupFields = document.getElementById('signup-fields');
            const btn = document.getElementById('driver-login-btn');
            const errorEl = document.getElementById('driver-login-error');

            errorEl.classList.add('hidden');

            if (this.isLoginMode) {
                tabLogin.className = 'flex-1 py-3 rounded-xl text-sm font-bold transition-all shadow-sm bg-white dark:bg-surface text-gray-900 dark:text-white';
                tabSignup.className = 'flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 dark:text-white/40 transition-all';
                signupFields.classList.add('hidden');
                btn.textContent = 'Iniciar SesiÃ³n';
            } else {
                tabSignup.className = 'flex-1 py-3 rounded-xl text-sm font-bold transition-all shadow-sm bg-white dark:bg-surface text-gray-900 dark:text-white';
                tabLogin.className = 'flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 dark:text-white/40 transition-all';
                signupFields.classList.remove('hidden');
                btn.textContent = 'Crear Cuenta de Repartidor';
            }
        },

        selectVehicle(type) {
            this.selectedVehicle = type;
            document.querySelectorAll('.vehicle-btn').forEach(btn => {
                if (btn.dataset.vehicle === type) {
                    btn.className = 'vehicle-btn flex flex-col items-center gap-1 py-3 rounded-xl border-2 border-primary bg-primary/5 transition-all active:scale-95';
                } else {
                    btn.className = 'vehicle-btn flex flex-col items-center gap-1 py-3 rounded-xl border border-gray-200 dark:border-white/10 transition-all active:scale-95';
                }
            });
        },

        // ============ AUTENTICACIÃ“N ============

        async submitAuth() {
            if (this.isLoginMode) {
                await this.login();
            } else {
                await this.register();
            }
        },

        async login() {
            const email = document.getElementById('driver-email').value;
            const password = document.getElementById('driver-password').value;
            const errorEl = document.getElementById('driver-login-error');
            const btn = document.getElementById('driver-login-btn');

            if (!email || !password) {
                errorEl.textContent = 'Completa todos los campos';
                errorEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Ingresando...';

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;

                // Verificar que sea repartidor
                const { data: driver, error: driverErr } = await supabaseClient
                    .from('repartidores')
                    .select('*')
                    .eq('user_id', data.user.id)
                    .single();

                if (driverErr || !driver) {
                    throw new Error('Esta cuenta no estÃ¡ registrada como repartidor. Usa "Registrarse" para crear tu perfil.');
                }

                this.profile = driver;
                this.showDashboard();

            } catch (err) {
                errorEl.textContent = err.message || 'Error de autenticaciÃ³n';
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Iniciar SesiÃ³n';
            }
        },

        async register() {
            const name = document.getElementById('driver-name-input').value.trim();
            const phone = document.getElementById('driver-phone-input').value.trim();
            const email = document.getElementById('driver-email').value.trim();
            const password = document.getElementById('driver-password').value;
            const errorEl = document.getElementById('driver-login-error');
            const btn = document.getElementById('driver-login-btn');

            if (!name || !phone || !email || !password) {
                errorEl.textContent = 'Completa todos los campos';
                errorEl.classList.remove('hidden');
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'La contraseÃ±a debe tener al menos 6 caracteres';
                errorEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creando cuenta...';

            try {
                // 1. Crear cuenta en Supabase Auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name,
                            phone: phone,
                            role: 'driver'
                        }
                    }
                });

                if (authError) throw authError;

                if (!authData.user) {
                    throw new Error('Error al crear la cuenta. Intenta de nuevo.');
                }

                // 2. Crear perfil de repartidor en la tabla
                const { data: driverProfile, error: driverError } = await supabaseClient
                    .from('repartidores')
                    .insert({
                        user_id: authData.user.id,
                        nombre: name,
                        telefono: phone,
                        vehiculo: this.selectedVehicle,
                        activo: true,
                        disponible: true
                    })
                    .select()
                    .single();

                if (driverError) {
                    console.error('Error creando perfil repartidor:', driverError);
                    // Si falla el insert pero el auth se creÃ³, intentar loguear de todas formas
                    throw new Error('Cuenta creada pero hubo un error registrando el perfil. Contacta al administrador.');
                }

                // 3. Ã‰xito: mostrar dashboard
                this.profile = driverProfile;
                this.notify('Â¡Cuenta creada exitosamente! Bienvenido ' + name);
                this.showDashboard();

            } catch (err) {
                console.error('Registration error:', err);
                let msg = err.message;
                if (msg.includes('User already registered')) msg = 'Este correo ya estÃ¡ registrado. Usa "Iniciar SesiÃ³n".';
                if (msg.includes('weak_password')) msg = 'La contraseÃ±a debe tener al menos 6 caracteres.';
                if (msg.includes('duplicate key') || msg.includes('unique constraint')) msg = 'Ya existe un repartidor con estos datos.';
                
                errorEl.textContent = msg;
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Crear Cuenta de Repartidor';
            }
        },

        async logout() {
            this.stopTracking();
            await supabaseClient.auth.signOut();
            this.profile = null;
            this.activeOrder = null;
            document.getElementById('driver-login').classList.remove('hidden');
            document.getElementById('driver-dashboard').classList.add('hidden');
            this.setMode('login');
        },

        // ============ DASHBOARD ============

        async showDashboard() {
            document.getElementById('driver-login').classList.add('hidden');
            document.getElementById('driver-dashboard').classList.remove('hidden');

            const nameEl = document.getElementById('driver-name');
            if (nameEl) nameEl.textContent = this.profile.nombre;

            await this.checkActiveOrder();
            await this.loadPendingOrders();
            await this.loadCompletedOrders();
            this.listenForNewOrders();
        },

        // ============ PEDIDOS ============

        async checkActiveOrder() {
            // Buscar si tiene un pedido "en camino" asignado
            const { data } = await supabaseClient
                .from('pedidos')
                .select('*')
                .eq('repartidor_id', this.profile.id)
                .in('estado', ['en camino', 'listo'])
                .order('created_at', { ascending: false })
                .limit(1);

            if (data && data.length > 0) {
                this.activeOrder = data[0];
                this.renderActiveOrder();
            }
        },

        async loadPendingOrders() {
            const container = document.getElementById('pending-orders-list');

            // Pedidos listos para recoger (estado: 'listo' o 'pendiente' sin repartidor)
            const { data, error } = await supabaseClient
                .from('pedidos')
                .select('*')
                .in('estado', ['pendiente', 'en preparacion', 'listo'])
                .is('repartidor_id', null)
                .order('created_at', { ascending: true });

            if (error || !data || data.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 opacity-40">
                        <span class="material-symbols-rounded text-4xl">inbox</span>
                        <p class="text-sm font-bold mt-2">Sin pedidos pendientes</p>
                    </div>`;
                return;
            }

            container.innerHTML = data.map(order => `
                <div class="bg-white dark:bg-surface border border-gray-100 dark:border-white/5 rounded-2xl p-5 shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-[10px] font-black uppercase text-primary tracking-widest">Orden #${order.id.slice(0,5)}</span>
                            <h4 class="font-bold text-sm">${order.cliente_nombre || 'Cliente'}</h4>
                        </div>
                        <span class="px-2 py-1 rounded-lg text-[9px] font-black uppercase bg-yellow-100 text-yellow-600">${order.estado}</span>
                    </div>
                    <div class="flex items-start gap-2 mb-4 bg-gray-50 dark:bg-black/20 p-3 rounded-xl">
                        <span class="material-symbols-rounded text-primary text-sm mt-0.5">location_on</span>
                        <p class="text-xs text-gray-600 dark:text-white/60 leading-relaxed">${order.direccion || 'Sin direcciÃ³n'}</p>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-lg font-display font-black">RD$${order.total}</span>
                        <button onclick="driverApp.acceptOrder('${order.id}')"
                            class="bg-primary text-white font-bold text-xs px-5 py-3 rounded-xl shadow-lg shadow-primary/20 active:scale-95 transition-all flex items-center gap-1">
                            <span class="material-symbols-rounded text-lg">check</span>
                            Aceptar
                        </button>
                    </div>
                </div>
            `).join('');
        },

        async loadCompletedOrders() {
            const container = document.getElementById('completed-orders-list');
            const today = new Date().toISOString().split('T')[0];

            const { data } = await supabaseClient
                .from('pedidos')
                .select('*')
                .eq('repartidor_id', this.profile.id)
                .eq('estado', 'entregado')
                .gte('entregado_at', today)
                .order('entregado_at', { ascending: false });

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">Sin entregas hoy</p>';
                return;
            }

            container.innerHTML = data.map(o => `
                <div class="flex items-center gap-3 bg-green-50 dark:bg-green-500/5 p-3 rounded-xl border border-green-100 dark:border-green-500/10">
                    <span class="material-symbols-rounded text-green-500">check_circle</span>
                    <div class="flex-1">
                        <p class="text-xs font-bold">#${o.id.slice(0,5)} â€” ${o.cliente_nombre || 'Cliente'}</p>
                        <p class="text-[10px] text-gray-400">${new Date(o.entregado_at).toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'})}</p>
                    </div>
                    <span class="font-bold text-sm text-green-600">RD$${o.total}</span>
                </div>
            `).join('');
        },

        // ============ ACEPTAR PEDIDO ============

        async acceptOrder(orderId) {
            if (this.activeOrder) {
                this.notify('Ya tienes un pedido activo', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('pedidos')
                    .update({
                        repartidor_id: this.profile.id,
                        estado: 'en camino',
                        tracking_activo: true
                    })
                    .eq('id', orderId);

                if (error) throw error;

                // Recargar
                const { data: order } = await supabaseClient
                    .from('pedidos')
                    .select('*')
                    .eq('id', orderId)
                    .single();

                this.activeOrder = order;
                this.renderActiveOrder();
                this.loadPendingOrders();
                this.notify('Â¡Pedido aceptado! Inicia la ruta.');

            } catch (err) {
                console.error(err);
                this.notify('Error al aceptar pedido', 'error');
            }
        },

        renderActiveOrder() {
            const control = document.getElementById('tracking-control');
            if (!control || !this.activeOrder) return;
            control.classList.remove('hidden');

            document.getElementById('active-order-id').textContent = `#${this.activeOrder.id.slice(0,5)} â€” ${this.activeOrder.cliente_nombre || 'Cliente'}`;
            document.getElementById('active-order-address').querySelector('p').textContent = this.activeOrder.direccion || 'Sin direcciÃ³n';
        },

        // ============ TRACKING GPS ============

        toggleTracking() {
            if (this.isTracking) {
                this.stopTracking();
            } else {
                this.startTracking();
            }
        },

        startTracking() {
            if (!this.activeOrder) {
                this.notify('No tienes un pedido activo', 'error');
                return;
            }

            if (!navigator.geolocation) {
                this.notify('GPS no disponible en este navegador', 'error');
                return;
            }

            this.isTracking = true;
            this.updateTrackingUI(true);

            // Iniciar watchPosition para GPS en tiempo real
            this.watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    this.lastPosition = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        bearing: pos.coords.heading || 0,
                        speed: pos.coords.speed ? (pos.coords.speed * 3.6) : 0 // m/s â†’ km/h
                    };
                },
                (err) => {
                    console.error('GPS Error:', err);
                    if (err.code === 1) {
                        this.notify('Permiso de ubicaciÃ³n denegado', 'error');
                        this.stopTracking();
                    }
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 5000,
                    timeout: 15000
                }
            );

            // Enviar ubicaciÃ³n cada 6 segundos
            this.sendInterval = setInterval(() => this.sendPosition(), 6000);

            // Enviar primera ubicaciÃ³n inmediata
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    this.lastPosition = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        bearing: pos.coords.heading || 0,
                        speed: pos.coords.speed ? (pos.coords.speed * 3.6) : 0
                    };
                    this.sendPosition();
                },
                () => {},
                { enableHighAccuracy: true }
            );

            this.notify('ðŸ›µ Tracking GPS activado');
        },

        stopTracking() {
            this.isTracking = false;

            if (this.watchId !== null) {
                navigator.geolocation.clearWatch(this.watchId);
                this.watchId = null;
            }
            if (this.sendInterval) {
                clearInterval(this.sendInterval);
                this.sendInterval = null;
            }

            this.updateTrackingUI(false);
        },

        async sendPosition() {
            if (!this.lastPosition || !this.activeOrder || !this.isTracking) return;

            try {
                await supabaseClient
                    .from('tracking_ubicaciones')
                    .insert({
                        pedido_id: this.activeOrder.id,
                        repartidor_id: this.profile.id,
                        latitud: this.lastPosition.lat,
                        longitud: this.lastPosition.lng,
                        bearing: this.lastPosition.bearing,
                        velocidad: this.lastPosition.speed
                    });
            } catch (err) {
                console.error('Error enviando ubicaciÃ³n:', err);
            }
        },

        updateTrackingUI(active) {
            const btn = document.getElementById('btn-toggle-tracking');
            const btnText = document.getElementById('btn-tracking-text');
            const indicator = document.getElementById('tracking-indicator');
            const deliveredBtn = document.getElementById('btn-mark-delivered');

            if (active) {
                btn.className = btn.className.replace('bg-primary', 'bg-red-500').replace('shadow-primary/20', 'shadow-red-500/20');
                btn.querySelector('.material-symbols-rounded').textContent = 'stop';
                btnText.textContent = 'Detener Tracking';
                indicator.innerHTML = '<span class="material-symbols-rounded text-primary text-2xl animate-pulse">my_location</span>';
                indicator.className = 'size-14 rounded-2xl bg-green-50 dark:bg-green-500/10 flex items-center justify-center pulse-ring';
                deliveredBtn.classList.remove('hidden');
            } else {
                btn.className = btn.className.replace('bg-red-500', 'bg-primary').replace('shadow-red-500/20', 'shadow-primary/20');
                btn.querySelector('.material-symbols-rounded').textContent = 'play_arrow';
                btnText.textContent = 'Iniciar Ruta';
                indicator.innerHTML = '<span class="material-symbols-rounded text-gray-400 text-2xl">location_off</span>';
                indicator.className = 'size-14 rounded-2xl bg-gray-100 dark:bg-white/5 flex items-center justify-center';
                deliveredBtn.classList.add('hidden');
            }
        },

        // ============ MARCAR ENTREGADO ============

        async markDelivered() {
            if (!this.activeOrder) return;

            try {
                this.stopTracking();

                await supabaseClient
                    .from('pedidos')
                    .update({
                        estado: 'entregado',
                        tracking_activo: false,
                        entregado_at: new Date().toISOString()
                    })
                    .eq('id', this.activeOrder.id);

                // Marcar repartidor como disponible
                await supabaseClient
                    .from('repartidores')
                    .update({ disponible: true })
                    .eq('id', this.profile.id);

                this.notify('âœ… Â¡Pedido entregado!');
                this.activeOrder = null;

                document.getElementById('tracking-control').classList.add('hidden');
                this.loadPendingOrders();
                this.loadCompletedOrders();

            } catch (err) {
                console.error(err);
                this.notify('Error al marcar entrega', 'error');
            }
        },

        // ============ DISPONIBILIDAD ============

        async toggleAvailability() {
            this.isAvailable = !this.isAvailable;

            await supabaseClient
                .from('repartidores')
                .update({ disponible: this.isAvailable })
                .eq('id', this.profile.id);

            const label = document.getElementById('driver-status-label');
            const icon = document.getElementById('icon-available');
            const btn = document.getElementById('btn-toggle-available');

            if (this.isAvailable) {
                label.textContent = 'Disponible';
                label.className = 'text-[10px] font-bold text-green-500 uppercase tracking-widest';
                icon.textContent = 'toggle_on';
                btn.className = btn.className.replace('bg-red-50', 'bg-green-50').replace('text-red-500', 'text-green-500').replace('dark:bg-red-500/10', 'dark:bg-green-500/10');
            } else {
                label.textContent = 'No Disponible';
                label.className = 'text-[10px] font-bold text-red-500 uppercase tracking-widest';
                icon.textContent = 'toggle_off';
                btn.className = btn.className.replace('bg-green-50', 'bg-red-50').replace('text-green-500', 'text-red-500').replace('dark:bg-green-500/10', 'dark:bg-red-500/10');
            }
        },

        // ============ REALTIME: Nuevos pedidos ============

        listenForNewOrders() {
            supabaseClient
                .channel('new-orders-driver')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'pedidos'
                }, () => {
                    this.loadPendingOrders();
                    this.notify('ðŸ†• Nuevo pedido disponible');
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'pedidos'
                }, () => {
                    this.loadPendingOrders();
                })
                .subscribe();
        },

        // ============ UTILIDADES ============

        notify(text, type = 'success') {
            const toast = document.getElementById('driver-toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-text');

            msg.textContent = text;
            icon.textContent = type === 'error' ? 'error' : 'check_circle';
            icon.className = `material-symbols-rounded text-xl ${type === 'error' ? 'text-red-500' : 'text-primary'}`;

            toast.classList.remove('opacity-0', '-translate-y-8', 'pointer-events-none');
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-8', 'pointer-events-none');
            }, 3000);
        },

        // ============ AUTO-INIT ============

        async init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;

            const { data: driver } = await supabaseClient
                .from('repartidores')
                .select('*')
                .eq('user_id', session.user.id)
                .single();

            if (driver) {
                this.profile = driver;
                this.showDashboard();
            }
        }
    };

    window.driverApp = driverApp;
    document.addEventListener('DOMContentLoaded', () => driverApp.init());
    </script>
</body>
</html>
